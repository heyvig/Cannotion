<!DOCTYPE html>
<html>
  
<head>
    <title>Read Text File</title>
</head>
  
<body>
    <input type="file" name="file" id="file" />

    <script type="text/javascript">
        //Defining the CalendarEvent class
        class CalendarEvent{
            title = "";
            year = 0;
            month = 0;
            day = 0;
            startHour = 0;
            startMinute = 0;
            endHour = 0;
            endMinute = 0;
            class = "";
            description = "";
            //Link is doable for assignments with modifications and zoom as well
            link = "";
            //AKA Office Hours, Class, Assignment, Exam, Quiz, etc.
            type = "";
            constructor(){
            
            }
            reset(){
                this.title = "";
                this.class = "";
                this.type = "";
                this.description = "";
                this.link = "";
                this.year = 0;
                this.month = 0;
                this.day = 0;

                this.hour = 0;
                this.minute = 0;
            }
        }

        //Create container for events

        const input = document.querySelector('input[type="file"]')
        input.addEventListener('change', function(e){
            console.log(input.files)
            const reader = new FileReader()
            reader.onload = function(){
                //Create new calendar event
                let newEvent = new CalendarEvent()
                var checkNext = false;
                var appendURL = false;
                var appendSummary = false;
                const lines = reader.result.split('\n').map(function(line){
                    if(!(line.includes("END:VCALENDAR") || line == "")){
                        
                        if(checkNext){
                            if(appendURL){
                                //Appending the 2nd line of the link
                                newEvent.link = newEvent.link + line.substring(12, line.length - 1)

                                //Splicing the link together to form a link to the assignment rather than the calendar event
                                if(line.includes("#assignment_")){
                                    newEvent.link = line.substring(4, 32) + "courses/" + line.substring(65, 70) + "/assignments/" + line.substring(65, 70)
                                }

                                appendURL = false
                            }
                            else if(appendSummary){
                                if(!line.includes("URL:")){
                                    //Continuously appending the next line of the summary until reaching the next attribute
                                    newEvent.title = newEvent.title + line.substring(1, line.length - 1)
                                }
                                else{
                                    //Updates the class (Ex. CEN3031) variable in the object
                                    newEvent.class = newEvent.title.substring(newEvent.title.lastIndexOf("[") + 1, newEvent.title.length - 1)
                                    
                                    //Determines the type of event based of intormation in the title and updates the corresponding variable
                                    if(newEvent.description.includes("[Click here to join Zoom Meeting:")){
                                        if(newEvent.title.toLowerCase.includes("office hours")){
                                            newEvent.type = "Office Hours"
                                        }
                                        else if(newEvent.title.toLowerCase.includes("discussion")){
                                            newEvent.type = "Discussion"
                                        }
                                        else if(newEvent.title.toLowerCase.includes("lab")){
                                            newEvent.type = "Lab"
                                        }
                                        else{
                                            newEvent.type = "Class"
                                        }

                                        //Updating the link variable with the respective zoom link
                                        newEvent.link = newEvent.description.substring(49, newEvent.description.length - 2)
                                    }
                                    else if(newEvent.description.toLowerCase.includes("exam") ||
                                            newEvent.description.toLowerCase.includes("test") ||
                                            newEvent.description.toLowerCase.includes("midterm") ||
                                            newEvent.description.toLowerCase.includes("final")){
                                        newEvent.type = "Exam"
                                    }
                                    else if(newEvent.description.toLowerCase.includes("quiz")){
                                        newEvent.type = "Quiz"
                                    }
//***********************Are there any other types of events?
                                    else{
                                        newEvent.type = "Assignment"
                                    }
                                    
                                    appendSummary = false
                                }
                            }
                            else if(!(line.includes("SEQUENCE:") || line.includes("LOCATION:"))){
                                //Continuously appending the next line of the description until reaching the next attribute
                                newEvent.description = newEvent.description + line.substring(1, line.length - 1)
                            }
                            else{
                                checkNext = false
                            }
                        }

                        //COME BACK TO DATE BC IT VARIES PER EVENT AND HAS TIME ZONE SHIFT
                        if(line.includes("DTSTART;VALUE=DATE:") || line.includes("DTSTART:")){
                            var date = ""
                            if(line.includes("DTSTART;VALUE=DATE:")){
                                date = line.substring(19, line.length - 1)
                            }
                            else if(line.includes("DTSTART:")){
                                date = line.substring(8, line.length - 1)
                                startHour = line.substring(18, 20)
                                startMinute = line.substring(20, 22)
                            }

                            year = date.substring(0, 4)
                            month = date.substring(4, 6)
                            day = date.substring(6, 8)

                            console.log(date)
                        }

                        //COME BACK TO DATE BC IT VARIES PER EVENT AND HAS TIME ZONE SHIFT
                        if(line.includes("DTSTART:")){
                            var date = line.substring(8, line.length - 1)
                            console.log(date)
                        }

                        if(line.includes("DESCRIPTION:")){
                            newEvent.description = line.substring(12, line.length - 1)
                            checkNext = true
                        }

                        if(line.includes("SUMMARY:")){
                            newEvent.title = line.substring(8, line.length - 1)
                            appendSummary = true
                            checkNext = true
                        }

                        if(line.includes("URL:")){
                            if(newEvent.type != "Office Hours" || newEvent.type != "Discussion" || newEvent.type != "Lab" || newEvent.type != "Class"){
                                newEvent.link = line.substring(4, line.length - 1)
                            }
                            appendURL = true
                            checkNext = true
                        }

                        if(line.includes("END:VEVENT:")){
                            //PUSH AKA COPY current event (NOT A POINTER) into collection
                            newEvent.reset()
                        }
                        //console.log(line)
                    }
                })
            }
            reader.readAsText(input.files[0])
        }, false)
        
        //document.getElementById('file').onchange = function(){
        //    var file = this.files[0];
        //    var reader = new FileReader();
        //    reader.onload = function(progressEvent){
        //        var fileContentArray = this.result.split(/\r\n|\n/);
        //        for(var line = 0; line < lines.length-1; line++){
        //            console.log(line + " --> "+ lines[line]);
        //        }
        //    };
        //    reader.readAsText(file);
        //}
    </script>

</body>

</html>